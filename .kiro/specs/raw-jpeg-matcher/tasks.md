# 実装計画

- [x] 1. プロジェクト構造とコア依存関係のセットアップ
  - プロジェクトディレクトリ構造を作成（src/、tests/ディレクトリ）
  - requirements.txtを作成し必要なライブラリを定義（exifread、pytest、hypothesis）
  - setup.pyまたはpyproject.tomlを作成してパッケージ設定を定義
  - _要件: 1.7_

- [x] 2. データモデルとエラークラスの実装
  - RawFileInfo、JpegFileInfo、ProcessingStatsのデータクラスを実装
  - カスタム例外クラス（ProcessingError、ValidationError、FileOperationError、ExifReadError）を実装
  - _要件: すべての要件の基礎_

- [x] 2.1 データモデルのプロパティテストを作成
  - **プロパティ6: インデックスの完全性**
  - **検証対象: 要件 4.2**

- [x] 3. PathValidatorの実装
  - ディレクトリの存在とアクセス権を検証する機能を実装
  - macOSとWindowsのパス形式をサポート
  - 無効なパスに対する明確なエラーメッセージを生成
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6_

- [x] 3.1 PathValidatorのプロパティテストを作成
  - **プロパティ1: ディレクトリ検証の一貫性**
  - **検証対象: 要件 1.1, 1.2, 1.3**

- [x] 3.2 PathValidatorのプロパティテストを作成
  - **プロパティ2: クロスプラットフォームパス処理**
  - **検証対象: 要件 1.4**

- [x] 4. FileScannerの実装
  - RAWファイル拡張子の定数を定義（大文字小文字両方: .cr2/.CR2, .cr3/.CR3, .nef/.NEF, .arw/.ARW, .raf/.RAF, .orf/.ORF, .rw2/.RW2, .pef/.PEF, .dng/.DNG, .rwl/.RWL, .3fr/.3FR, .iiq/.IIQ）
  - JPEG拡張子の定数を定義（大文字小文字両方: .jpg/.JPG, .jpeg/.JPEG）
  - ディレクトリをスキャンしてRAWファイルを検索する機能を実装
  - ディレクトリをスキャンしてJPEGファイルを検索する機能を実装
  - 再帰的スキャンのサポート
  - _要件: 2.1, 3.5_

- [x] 4.1 FileScannerのプロパティテストを作成
  - **プロパティ3: ベース名抽出の一貫性**
  - **検証対象: 要件 2.1, 2.2, 2.3**

- [x] 5. ExifReaderの再実装（ExifTool対応）
  - ExifToolの自動検出機能を実装（Windows/macOS/Linux対応）
  - subprocessを使用してExifToolを実行する機能を実装
  - JPEGファイルから撮影日時を抽出（DateTimeOriginal, CreateDate, ModifyDateの順で試行）
  - RAWファイルから撮影日時を抽出（CR3を含むすべての主要なRAW形式をサポート）
  - 読み取り結果をキャッシュする機能を実装
  - ExifTool未インストール時のエラーハンドリングと案内メッセージ
  - Exifデータが欠落または破損している場合のエラーハンドリング
  - _要件: 3.1, 3.2, 3.4, 3.5, 3.6, 3.7, 6.2_

- [x] 5.1 ExifReaderのプロパティテストを作成
  - **プロパティ4: Exif日時抽出**
  - **検証対象: 要件 3.1, 3.2**

- [x] 5.2 ExifReaderのプロパティテストを更新
  - **プロパティ9: Exifキャッシュの一貫性**
  - **検証対象: 要件 6.2**

- [x] 5.3 ExifReaderのプロパティテストを作成
  - **プロパティ14: ExifTool依存性の検証**
  - **検証対象: 要件 3.7**

- [x] 6. Indexerの実装
  - RawFileIndexクラスを実装（ベース名と日時でインデックス化）
  - インデックスへのRAWファイル情報の追加・削除機能を実装
  - ベース名でRAWファイルを検索する機能を実装
  - 撮影日時でRAWファイルを検索する機能を実装
  - インデックスの永続化機能を実装（JSON形式でユーザーディレクトリの~/.raw_jpeg_matcher/cacheに保存）
  - IndexCacheクラスを実装（キャッシュ管理）
  - 差分更新機能を実装（新規・更新・削除ファイルの検出と処理）
  - 並列処理を使用してインデックスを構築する機能を実装
  - _要件: 4.1, 4.2, 4.5, 9.1, 9.2, 9.4, 9.5_

- [x] 6.1 Indexerのプロパティテストを作成
  - **プロパティ11: インデックス永続化の一貫性**
  - **検証対象: 要件 9.1**

- [x] 6.2 Indexerのプロパティテストを作成
  - **プロパティ12: 差分更新の正確性**
  - **検証対象: 要件 9.2, 9.4, 9.5**

- [x] 7. Matcherの実装
  - MatchResultデータクラスを実装
  - JPEGファイルに対応するRAWファイルを検索する機能を実装
  - ファイル名でフィルタリング（大文字小文字を区別しない比較）
  - Exif日時で検証（完全一致のみ）
  - 複数の候補がある場合の処理
  - _要件: 2.2, 2.3, 2.4, 3.3_

- [x] 7.1 Matcherのプロパティテストを作成
  - **プロパティ5: 日時マッチングの厳密性**
  - **検証対象: 要件 3.3**

- [x] 8. Copierの実装
  - CopyResultデータクラスを実装
  - マッチしたRAWファイルをターゲットディレクトリにコピーする機能を実装
  - 元のファイル名を保持
  - 既存ファイルのスキップ処理
  - コピー失敗時のエラーハンドリングと処理継続
  - ディスク容量チェック
  - _要件: 5.1, 5.2, 5.3, 5.4, 8.3_

- [x] 8.1 Copierのプロパティテストを作成
  - **プロパティ7: ファイルコピーの保存性**
  - **検証対象: 要件 5.1, 5.2**

- [x] 9. ロギングと進捗表示の実装
  - ログシステムのセットアップ（標準出力とファイル出力）
  - 処理開始時のサマリー表示
  - インデックス構築時の進捗表示
  - マッチング時の進捗表示
  - 処理完了時のサマリー表示
  - エラーログの詳細記録（ファイルパスとエラー説明）
  - _要件: 6.4, 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 9.1 ロギングのプロパティテストを作成
  - **プロパティ10: エラーログの完全性**
  - **検証対象: 要件 7.5**

- [x] 10. IndexManagerクラスの実装
  - インデックス作成と管理を担当するIndexManagerクラスを実装
  - 複数ディレクトリのインデックス管理機能
  - 差分更新機能（同じディレクトリの場合）
  - 新規追加機能（別ディレクトリの場合）
  - インデックス一覧表示機能
  - _要件: 9.1, 9.2, 9.4, 9.5, 10.1, 10.4_

- [x] 10.1 IndexManagerのプロパティテストを作成
  - **プロパティ12: 差分更新の正確性**
  - **検証対象: 要件 9.2, 9.4, 9.5**

- [x] 11. MatchManagerクラスの実装
  - マッチング処理を担当するMatchManagerクラスを実装
  - 全インデックスからのRAWファイル検索機能
  - 特定ソースディレクトリフィルタリング機能
  - インデックス存在チェックと警告表示機能
  - JPEGファイルとのマッチング処理
  - RAWファイルのコピー処理
  - 結果レポート機能
  - _要件: 10.2, 10.3, 10.5, 10.7_

- [x] 11.1 MatchManagerのプロパティテストを作成
  - **プロパティ8: 処理サマリーの正確性**
  - **検証対象: 要件 5.5**

- [x] 11.2 MatchManagerのプロパティテストを作成
  - **プロパティ13: インデックス不足時の警告表示**
  - **検証対象: 要件 10.7**

- [x] 12. CLIインターフェースの実装
  - argparseのサブコマンド機能を使用してコマンド構造を実装
  - indexコマンドの実装（エイリアス: i）
    - sourceディレクトリ（位置引数）
    - --no-recursive/-nrオプション（サブディレクトリを検索しない、デフォルトは再帰的に検索）
    - --verbose/-vオプション（詳細ログを表示）
    - --force-rebuild/-fオプション（該当ディレクトリのインデックスを強制的に再構築）
  - matchコマンドの実装（エイリアス: m）
    - targetディレクトリ（位置引数）
    - --no-recursive/-nrオプション（サブディレクトリを検索しない、デフォルトは再帰的に検索）
    - --verbose/-vオプション（詳細ログを表示）
    - --source-filter/-sオプション（特定のソースディレクトリのみを対象）
  - list-indexコマンドの実装（エイリアス: l）
    - --verbose/-vオプション（詳細情報を表示）
  - clear-cacheコマンドの実装（エイリアス: c）
    - --source/-sオプション（特定ディレクトリのキャッシュのみクリア、省略時は全体）
  - メインエントリーポイントの実装
  - _要件: 1.1, 1.2, 9.3, 10.4, 10.5_

- [x] 13. チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、問題があればユーザーに質問するのです。

- [x] 14. エッジケースのユニットテストを作成
  - Exifデータが欠落しているファイルの処理テスト
  - 破損したExifデータの処理テスト
  - ターゲットディレクトリに既存ファイルがある場合のテスト
  - ディスク容量不足のテスト
  - ファイル権限エラーのテスト
  - 未対応のファイル形式のテスト
  - マッチしないJPEGファイルの処理テスト
  - _要件: 3.4, 5.3, 8.1, 8.2, 8.3, 8.4, 8.5_

- [x] 15. テストデータの準備
  - tests/data/ディレクトリを作成
  - 一致するJPEG-RAWペアのサンプルファイルを配置（同じ撮影日時とベース名）
  - 一致しないJPEG-RAWペアのサンプルファイルを配置（異なる撮影日時またはベース名）
  - ベース名は同じだが撮影日時が異なるJPEG-RAWペアのサンプルファイルを配置（マッチしないことを確認するため）
  - _要件: 3.3, 3.5, 8.1_

- [x] 16. 統合テストを作成
  - エンドツーエンドの処理フローをテスト
  - 準備したサンプルファイルを使用したテスト
  - macOSとWindowsでの動作確認
  - 各カメラメーカーのRAW形式のテスト
  - 一致するペアと一致しないペアの両方をテスト
  - _要件: 1.5, 1.6, 3.5_

- [x] 17. ドキュメントの作成
  - README.md を英語で作成（インストール手順、使用方法、例）
  - README_jp.md を日本語で作成（インストール手順、使用方法、例）
  - コード内のdocstringを追加
  - 使用例のスクリプトを作成
  - テストデータの説明ドキュメントを作成
  - _要件: すべての要件_

- [x] 18. 最終チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、問題があればユーザーに質問するのです。
