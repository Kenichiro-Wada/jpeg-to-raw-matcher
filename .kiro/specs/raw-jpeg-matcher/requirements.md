# Requirements Document

## Introduction

本システムは、特定のディレクトリ内のJPEGファイルに対応するRAWファイルを検索し、同じ場所にコピーするPythonベースのツールです。写真家やフォトグラファーが、選択したJPEG画像に対応するRAWファイルを効率的に収集することを目的としています。本システムはPython 3.10以上で実装され、macOSとWindows環境の両方で動作します。

## Glossary

- **System**: RAW-JPEG Matcher Tool
- **JPEG File**: .jpg または .jpeg 拡張子を持つ画像ファイル
- **RAW File**: カメラメーカー固有の未加工画像ファイル（.CR2, .NEF, .ARW, .RAF, .ORF, .DNG など）
- **Source Directory**: RAWファイルが保存されているディレクトリ
- **Target Directory**: JPEGファイルが保存されているディレクトリ
- **Exif Data**: 画像ファイルに埋め込まれたメタデータ（撮影日時、カメラ設定など）
- **Capture DateTime**: Exif情報内の撮影日時
- **Index**: RAWファイルの情報を事前に収集したデータベース

## 要件

### 要件1

**ユーザーストーリー:** フォトグラファーとして、JPEGファイルとRAWファイルを含むディレクトリを指定したい。そうすることで、システムがマッチするRAWファイルを見つけてコピーできる。

#### 受け入れ基準

1. WHEN ユーザーがターゲットディレクトリパスを提供する THEN システムはディレクトリが存在しアクセス可能であることを検証しなければならない
2. WHEN ユーザーがソースディレクトリパスを提供する THEN システムはディレクトリが存在しアクセス可能であることを検証しなければならない
3. WHEN ディレクトリパスが無効である THEN システムはどのパスが無効かを示す明確なエラーメッセージを報告しなければならない
4. WHEN システムがディレクトリを処理する THEN システムはmacOSとWindowsの両方のパス形式をサポートしなければならない
5. WHEN システムがmacOS上で実行される THEN システムはPOSIXスタイルのパスを正しく処理しなければならない
6. WHEN システムがWindows上で実行される THEN システムはドライブレター付きのWindowsスタイルのパスを正しく処理しなければならない
7. WHEN システムが実装される THEN システムはPython 3.10以上をプログラミング言語として使用しなければならない

### 要件2

**ユーザーストーリー:** フォトグラファーとして、システムがファイル名でJPEGファイルとRAWファイルをマッチングしてほしい。そうすることで、同じベース名を持つファイルが正しくペアリングされる。

#### 受け入れ基準

1. WHEN ファイル名を比較する THEN システムはJPEGファイルとRAWファイルの両方から拡張子を除いたベースファイル名を抽出しなければならない
2. WHEN ベースファイル名が完全に一致する THEN システムはそれらのファイルを潜在的なマッチと見なさなければならない
3. WHEN ファイル名を比較する THEN システムは異なる命名規則を処理するために大文字小文字を区別しない比較を実行しなければならない
4. WHEN 複数のRAWファイルが同じベースファイル名を持つ THEN システムは正しいマッチを決定するために追加の基準を使用しなければならない

### 要件3

**ユーザーストーリー:** フォトグラファーとして、システムがExif撮影日時を使用してマッチを検証してほしい。そうすることで、同じ撮影からのファイルのみがペアリングされる。

#### 受け入れ基準

1. WHEN システムがJPEGファイルからExifデータを読み取る THEN システムは撮影日時の値を抽出しなければならない
2. WHEN システムがRAWファイルからExifデータを読み取る THEN システムは撮影日時の値を抽出しなければならない
3. WHEN 撮影日時を比較する THEN システムは日時の値が同一である場合のみファイルをマッチと見なさなければならない
4. WHEN Exifデータが欠落しているまたは読み取れない THEN システムは警告をログに記録しそのファイルをスキップしなければならない
5. WHEN システムがRAWファイルを処理する THEN システムはCanon (.CR2, .CR3)、Nikon (.NEF)、Sony (.ARW)、Fujifilm (.RAF)、Olympus (.ORF)、Panasonic (.RW2)、Pentax (.PEF)、Leica (.DNG, .RWL)、Hasselblad (.3FR)、Phase One (.IIQ)、Adobe (.DNG)を含むすべての主要なカメラメーカーの形式からExif抽出をサポートしなければならない
6. WHEN カメラメーカーから新しいRAWファイル形式がリリースされる THEN システムはExifToolなどの外部ツールを使用して最新のRAW形式をサポートしなければならない
7. WHEN システムがExif情報を読み取る THEN システムはExifToolが利用可能であることを確認し、利用できない場合は明確なエラーメッセージを表示しなければならない

### 要件4

**ユーザーストーリー:** フォトグラファーとして、システムがRAWファイルを事前にインデックス化してほしい。そうすることで、大規模なファイルコレクションでもマッチング操作が迅速に実行される。

#### 受け入れ基準

1. WHEN システムが処理を開始する THEN システムはマッチングの前にソースディレクトリをスキャンしすべてのRAWファイルのインデックスを構築しなければならない
2. WHEN インデックスを構築する THEN システムは各RAWファイルのベースファイル名、フルパス、撮影日時を保存しなければならない
3. WHEN インデックスが完成する THEN システムはその後のすべてのマッチング操作にインデックスを使用しなければならない
4. WHEN マッチを検索する THEN システムはファイルシステムを繰り返しスキャンするのではなくインデックスをクエリしなければならない
5. WHEN システムがインデックスを構築する THEN システムはインデックス作成時間を最小化するためにファイルを並列処理しなければならない

### 要件5

**ユーザーストーリー:** フォトグラファーとして、マッチしたRAWファイルをターゲットディレクトリにコピーしてほしい。そうすることで、選択したすべてのRAWファイルを1つの場所に持つことができる。

#### 受け入れ基準

1. WHEN RAWファイルがJPEGファイルとマッチする THEN システムはRAWファイルをターゲットディレクトリにコピーしなければならない
2. WHEN ファイルをコピーする THEN システムは元のRAWファイル名を保持しなければならない
3. WHEN RAWファイルがターゲットディレクトリに既に存在する THEN システムはコピーをスキップしメッセージをログに記録しなければならない
4. WHEN コピーが失敗する THEN システムはエラーをログに記録し残りのファイルの処理を続行しなければならない
5. WHEN すべてのマッチが処理される THEN システムはコピーされたファイルの総数と発生したエラーを報告しなければならない

### 要件6

**ユーザーストーリー:** フォトグラファーとして、システムがファイルを効率的に処理してほしい。そうすることで、過度な待ち時間なしに大規模な写真コレクションを処理できる。

#### 受け入れ基準

1. WHEN システムが複数のファイルを処理する THEN システムはスループットを最大化するために可能な限り並列処理を使用しなければならない
2. WHEN Exifデータを読み取る THEN システムは冗長なファイル読み取りを避けるために結果をキャッシュしなければならない
3. WHEN ファイルをコピーする THEN システムはオペレーティングシステムに適した効率的なファイルI/O操作を使用しなければならない
4. WHEN 大規模なディレクトリを処理する THEN システムは処理状況を示す進捗インジケーターを提供しなければならない

### 要件7

**ユーザーストーリー:** フォトグラファーとして、処理中に明確なフィードバックがほしい。そうすることで、システムが何をしているかを理解し問題を特定できる。

#### 受け入れ基準

1. WHEN システムが処理を開始する THEN システムはソースディレクトリとターゲットディレクトリのサマリーを表示しなければならない
2. WHEN システムがインデックスを構築する THEN システムは見つかったRAWファイルの数を表示しなければならない
3. WHEN システムがファイルをマッチングする THEN システムは処理されたファイル数と見つかったマッチ数を含む進捗情報を表示しなければならない
4. WHEN システムが処理を完了する THEN システムは総マッチ数、コピーされたファイル数、エラーを含むサマリーを表示しなければならない
5. WHEN エラーが発生する THEN システムはファイルパスとエラーの説明を含む詳細なエラーメッセージをログに記録しなければならない

### 要件8

**ユーザーストーリー:** フォトグラファーとして、システムがエッジケースを適切に処理してほしい。そうすることで、予期しない状況がクラッシュやデータ損失を引き起こさない。

#### 受け入れ基準

1. WHEN JPEGファイルにマッチするRAWファイルがない THEN システムはマッチしないファイルをログに記録し処理を続行しなければならない
2. WHEN RAWファイルが破損したExifデータを持つ THEN システムは警告をログに記録しファイル名のみのマッチングを試みなければならない
3. WHEN ターゲットディレクトリのディスク容量が不足している THEN システムはコピーの前にその状態を検出しエラーを報告しなければならない
4. WHEN ファイルのアクセス権限が読み取りまたは書き込みを妨げる THEN システムはアクセス権限エラーをログに記録しアクセス可能なファイルで処理を続行しなければならない
5. WHEN システムが予期しないファイル形式に遭遇する THEN システムはそれらのファイルをスキップし警告をログに記録しなければならない

### 要件9

**ユーザーストーリー:** フォトグラファーとして、RAWファイルのインデックス情報を永続化してほしい。そうすることで、同じディレクトリを再処理する際に高速化できる。

#### 受け入れ基準

1. WHEN システムがインデックスを構築する THEN システムはインデックス情報をユーザーディレクトリの隠しフォルダに保存しなければならない
2. WHEN システムが同じソースディレクトリを再処理する THEN システムは保存されたインデックスを読み込み差分更新を実行しなければならない
3. WHEN ユーザーがインデックスクリアを要求する THEN システムは保存されたすべてのインデックス情報を削除しなければならない
4. WHEN ファイルが変更または削除されている THEN システムはインデックスから該当エントリを更新または削除しなければならない
5. WHEN 新しいRAWファイルが追加されている THEN システムはそれらのファイルのみをインデックスに追加しなければならない

### 要件10

**ユーザーストーリー:** フォトグラファーとして、複数のRAWファイルディレクトリを管理してほしい。そうすることで、異なる場所に保存されたRAWファイルを統合的に検索できる。

#### 受け入れ基準

1. WHEN システムが新しいソースディレクトリをインデックス化する THEN システムは既存のインデックス情報を保持しつつ新しいディレクトリの情報を追加しなければならない
2. WHEN システムがマッチング処理を実行する THEN システムはすべてのインデックス化されたディレクトリからRAWファイルを検索しなければならない
3. WHEN ユーザーが特定のソースディレクトリを指定する THEN システムはそのディレクトリのRAWファイルのみを検索対象にしなければならない
4. WHEN ユーザーがインデックス一覧を要求する THEN システムはすべてのインデックス化されたディレクトリとその情報を表示しなければならない
5. WHEN システムがインデックスとマッチングを分離実行する THEN システムは各処理を独立して実行できなければならない
6. WHEN システムがディレクトリを処理する THEN システムはデフォルトで指定されたディレクトリとそのサブディレクトリを再帰的に処理しなければならない
7. WHEN マッチング処理時にインデックス情報が存在しない THEN システムは警告メッセージを表示しインデックス再構築を推奨しなければならない